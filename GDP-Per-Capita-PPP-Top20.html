<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>GDP per Capita (PPP) — Top 20 | PIB par habitant (PPA)</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  background:linear-gradient(145deg,#0f172a 0%,#1e293b 50%,#0f172a 100%);
  color:#f8fafc;min-height:100vh;-webkit-font-smoothing:antialiased;
}
.ctr{max-width:1140px;margin:0 auto;padding:20px 16px 40px}
.hdr{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;margin-bottom:16px}
.hdr h1{font-size:23px;font-weight:700;line-height:1.3;letter-spacing:-.4px}
.hdr h1 span{color:#94a3b8;font-weight:400;font-size:14px;margin-left:8px}
.hdr .sub{color:#64748b;font-size:13px;margin-top:4px;line-height:1.5}
.b{padding:7px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;
  border:1px solid rgba(148,163,184,.2);background:rgba(30,41,59,.6);color:#94a3b8;
  font-family:inherit;transition:all .2s;white-space:nowrap}
.b:hover{border-color:rgba(148,163,184,.4);color:#cbd5e1}
.b.on{border-color:#3b82f6;background:rgba(59,130,246,.15);color:#60a5fa}
.br{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
.cc{background:rgba(30,41,59,.4);border-radius:12px;border:1px solid rgba(148,163,184,.1);padding:12px;position:relative}
canvas{display:block;width:100%!important}
.lc{background:rgba(30,41,59,.4);border-radius:10px;border:1px solid rgba(148,163,184,.1);padding:14px 16px;margin-top:12px}
.lh{font-size:11px;color:#64748b;margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.lg{display:flex;flex-wrap:wrap;gap:4px 14px}
.li{display:flex;align-items:center;gap:6px;cursor:pointer;padding:4px 8px;border-radius:5px;transition:all .2s;user-select:none}
.li:hover{background:rgba(59,130,246,.08)}
.li.on{background:rgba(59,130,246,.12)}
.li.dim{opacity:.28}
.ls{width:14px;height:3px;border-radius:2px;flex-shrink:0}
.ln{font-size:12px;color:#e2e8f0;white-space:nowrap}
.lv{font-size:11px;color:#64748b;font-family:monospace}
.info{margin-top:16px;padding:0 4px}
.info p{color:#94a3b8;font-size:13px;line-height:1.7}
.info p strong{color:#cbd5e1}
.info .src{color:#64748b;font-size:12px;line-height:1.6;margin-top:8px}
.info .src strong{color:#94a3b8}
.ac{margin-top:28px;background:rgba(30,41,59,.3);border-radius:12px;border:1px solid rgba(148,163,184,.08);padding:28px 32px}
.ac h2{font-size:21px;font-weight:700;margin-bottom:20px;letter-spacing:-.3px}
.ai{margin-bottom:20px}
.ai h3{font-size:15px;font-weight:600;color:#e2e8f0;margin-bottom:6px}
.ai p{font-size:14px;color:#94a3b8;line-height:1.75}
.an{font-size:12px;color:#64748b;line-height:1.6;margin-top:8px;font-style:italic;border-top:1px solid rgba(148,163,184,.1);padding-top:14px}
.ft{margin-top:28px;text-align:center;color:#475569;font-size:11px;line-height:1.6}

/* Tooltip overlay */
#tip{position:absolute;pointer-events:none;background:rgba(15,23,42,.96);border:1px solid rgba(148,163,184,.2);
  border-radius:8px;padding:10px 14px;font-size:12px;display:none;z-index:10;max-height:420px;overflow-y:auto;
  min-width:170px;box-shadow:0 8px 32px rgba(0,0,0,.4)}
#tip .th{color:#94a3b8;font-size:12px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;margin-bottom:6px}
#tip .tr{display:flex;align-items:center;gap:7px;padding:1.5px 0}
#tip .td{width:8px;height:8px;border-radius:50%;flex-shrink:0}
#tip .tn{color:#e2e8f0;flex:1}
#tip .tv{color:#f8fafc;font-weight:600;font-family:monospace;white-space:nowrap}

@media(max-width:640px){
  .hdr h1{font-size:18px}
  .hdr h1 span{font-size:11px;display:block;margin-left:0;margin-top:4px}
  .ac{padding:20px 16px}
  .ac h2{font-size:18px}
}
</style>
</head>
<body>
<div class="ctr">
  <div class="hdr"><div><h1 id="pt"></h1><p class="sub" id="ps"></p></div>
    <button class="b" id="lb" onclick="TL()"></button></div>
  <div class="br" id="vb"></div>
  <div class="cc" id="ccw"><canvas id="cv"></canvas><div id="tip"></div></div>
  <div class="lc"><div class="lh" id="lht"></div><div class="lg" id="lgd"></div></div>
  <div class="info"><p id="df"></p><p class="src" id="sr"></p></div>
  <div class="ac" id="acd"></div>
  <div class="ft" id="ftr"></div>
</div>
<script>
(function(){
"use strict";

/* ═══ DATA ═══ */
var YR=[];for(var y=2004;y<=2024;y++)YR.push(y);
var D={
"Luxembourg":[95.8,97.6,101.8,107.3,104.2,99.1,103.8,106,105.5,109.7,114.5,115.9,118.1,117.7,118.5,120.3,117.5,122.3,121.5,124.8,127.6],
"Singapore":[63.2,67.5,72.1,77.5,73.7,72.5,82.9,87.2,88.9,92.8,95.7,97.5,100.2,104.7,107.2,107.6,104,112.8,116,116.5,119.2],
"Ireland":[51.8,53.5,55.2,57.2,53.4,52.3,53.3,55.8,55.4,56.5,71.2,95.3,96.4,103.1,108.1,112.4,117.8,133.2,128.9,118.5,117],
"Qatar":[110.5,108.3,116,118.7,122.4,112.8,125.5,134.2,131.3,132.4,131,123.1,118.4,112.6,112,111.5,102.3,103.8,110.2,105.4,100.8],
"Macao":[52.4,55.8,62.8,71.5,74.6,74,89.2,100.8,107.2,112.4,107.3,96.7,96.2,103.5,100.3,92.3,42.1,54.3,30.5,65.4,82.5],
"Switzerland":[62,63.1,65.8,68.3,66.2,65,67,67.8,68.2,69.3,71,72.1,73.3,74.3,76.2,77.5,75,79.8,81,81.5,82],
"Norway":[67.5,68.2,69.4,70.8,70.4,68.9,69.3,69.6,71.4,72,73.2,74.5,75,76.5,77,77.8,76.5,80.2,81.8,82.4,82],
"United States":[54.8,56.2,57.5,58.3,57.8,55.9,57.3,58.2,59.3,60.2,61.6,63.1,64,65.2,67,68.4,66.1,69.8,71.5,73.4,75.8],
"UAE":[67.2,64.8,68.5,65.2,64,61.3,61.8,63.2,63.7,66.2,67.8,69,70.5,69.8,70.2,72.4,67.8,68.5,73.2,74,73.5],
"Hong Kong":[43.5,46.2,48.5,51.2,49.8,48,51.5,53.2,53.8,56.1,58,59.5,60.8,63.2,64.5,62.8,55.8,62.3,59.4,63.8,66],
"Denmark":[50.2,51.3,53,53.2,51.8,49.8,51,52,52.3,53,54.2,55.5,57.5,59.2,60.5,62,59.8,64.2,67.5,68,69.5],
"Netherlands":[49.5,50.8,52.5,54.2,53,51.2,51.8,52.8,52.2,53,54.2,55.5,56.5,58.2,59.8,61.2,58.2,63.5,68,68.5,69],
"Taiwan":[36.2,38,40,42.5,41.8,39.5,47.2,51,52.5,54,56.2,56.5,57.8,60.2,62,64.5,66.8,70.2,71.5,67.8,70],
"Iceland":[47,49.5,49.8,50.5,50.8,47.2,44.5,46.2,47.5,50,51.8,53.5,57.2,59,61.2,63,58.8,63,68.3,70.5,68.5],
"Sweden":[45.8,47,48.8,50,49.2,46.8,49.2,50.5,50,51.2,52.5,55,55.8,56.5,57.5,58.8,57,60.2,63.2,63,63.8],
"Austria":[46.2,47,48.5,50.2,49,46,47,48.3,48.8,48.5,49.2,50,51.5,52.5,54,55.2,51.8,55.8,58.8,58.5,59.2],
"Germany":[43,43.5,45.8,47.5,47.8,45,47,49.2,49.5,49.8,51.2,51.8,52.8,54.5,55.2,56,53.5,55.8,57.8,57.5,58],
"Belgium":[44.2,45,46,47.2,46.8,45.5,46.5,47.2,47.5,47.5,48.8,49.5,50,51,52,53.2,50.8,54.5,57.2,57.8,58.5],
"Australia":[45.5,46.5,47.2,48.5,49,49.5,50,51,52.5,53,53.8,54.5,55.5,56,57,57.8,57,59.5,61,62.5,62.8],
"Canada":[45.5,46.2,47,47.5,47.5,45.8,46.8,48,48.5,49.5,50.5,50.8,51.2,52.5,53.8,54.2,51.8,53.5,55,56,56.5]
};

var FN={
"Luxembourg":"Luxembourg","Singapore":"Singapour","Ireland":"Irlande",
"Qatar":"Qatar","Macao":"Macao","Switzerland":"Suisse",
"Norway":"Norv\u00e8ge","United States":"\u00c9tats-Unis","UAE":"\u00c9mirats arabes unis",
"Hong Kong":"Hong Kong","Denmark":"Danemark","Netherlands":"Pays-Bas",
"Taiwan":"Ta\u00efwan","Iceland":"Islande","Sweden":"Su\u00e8de",
"Austria":"Autriche","Germany":"Allemagne","Belgium":"Belgique",
"Australia":"Australie","Canada":"Canada"
};

var PAL=["#E63946","#1D3557","#2A9D8F","#F4A261","#6A0572",
"#457B9D","#E76F51","#264653","#A7C957","#BC6C25",
"#0077B6","#D62828","#F77F00","#023047","#219EBC",
"#8338EC","#FF006E","#3A86FF","#FB5607","#FFBE0B"];

/* ═══ i18n ═══ */
var T={
en:{
t:"GDP per Capita, PPP",ts:"(constant 2021 international $)",
ds:"Top 20 countries ranked by most recent year \u2014 2004 to 2024  |  Source: World Bank WDI (NY.GDP.PCAP.PP.KD), IMF WEO",
lb:"Fran\u00e7ais",
v:["Top 10","Ranks 11\u201320","All Top 20"],
lh:"Click a country to highlight \u00b7 click again to reset",
xl:"Year",yl:"GDP per Capita (const. 2021 intl $, thousands)",
dl:"Definition",
dt:"GDP per capita based on purchasing power parity (PPP), expressed in constant 2021 international dollars. PPP conversion factors account for price-level differences across countries; constant prices adjust for inflation over time, enabling meaningful cross-country and cross-year comparisons.",
sl:"Sources",
st:"World Bank World Development Indicators (indicator NY.GDP.PCAP.PP.KD); International Comparison Program (ICP); IMF World Economic Outlook. Data compiled as of early 2025. Note: Some high-GDP-per-capita jurisdictions (e.g., Ireland, Luxembourg, Singapore) have figures influenced by multinational corporate accounting and tax-haven effects.",
at:"Key Observations",
a:[
["Luxembourg stays on top","Luxembourg has consistently held the #1 or #2 position over the past two decades. Its outsized GDP per capita reflects a small population combined with a massive financial services sector \u2014 the country hosts the European headquarters of many global banks and investment funds."],
["Qatar\u2019s long decline from peak","Qatar was the clear global leader in 2010\u20132013, peaking above $134k, driven by enormous natural gas revenues divided among a relatively small citizen population. Since then, population growth and diversification efforts have gradually reduced per-capita output in PPP terms."],
["Ireland\u2019s \u2018leprechaun economics\u2019 jump","Ireland\u2019s dramatic leap around 2015 is one of the most striking features on the chart. This reflects multinational corporations (especially in tech and pharma) reclassifying intellectual property assets through Irish subsidiaries \u2014 inflating GDP without a proportional change in residents\u2019 living standards. Ireland itself acknowledged this distortion and created an alternative metric called GNI* (modified gross national income)."],
["Macao\u2019s COVID collapse and recovery","Macao\u2019s economy, almost entirely dependent on casino gaming and tourism, experienced the most dramatic swing of any jurisdiction on the chart. Its GDP per capita fell from over $100k to around $30k during the pandemic lockdowns, and has been recovering since China reopened borders."],
["Taiwan\u2019s steady ascent","Taiwan\u2019s trajectory is perhaps the most impressive sustained growth story here \u2014 nearly doubling from ~$36k in 2004 to ~$70k by 2024, driven by its dominant position in semiconductor manufacturing (TSMC) and a diversified tech export economy."],
["The Nordics & Western Europe: steady but tightly bunched","Denmark, Netherlands, Sweden, Iceland, Germany, Austria, Belgium, and the other Western European nations cluster between $58k and $70k \u2014 growing steadily but at similar rates, reflecting mature economies with strong social safety nets and diversified industrial bases."],
["The United States: pulling ahead","Among large economies, the U.S. stands out for accelerating growth post-2020, reaching ~$76k \u2014 considerably above its Western European peers. This divergence has been driven by the tech sector, higher labor productivity growth, and different fiscal policy choices."]
],
an:"These observations are meant as starting points for discussion. GDP per capita (PPP) is a useful but imperfect proxy for material living standards \u2014 it does not capture income distribution, quality of public services, environmental sustainability, or subjective wellbeing.",
bw:"Data from World Bank & IMF"
},
fr:{
t:"PIB par habitant (PPA)",ts:"(dollars internationaux constants de 2021)",
ds:"Les 20 premiers pays class\u00e9s par l\u2019ann\u00e9e la plus r\u00e9cente \u2014 2004 \u00e0 2024  |  Source : Banque mondiale IDM (NY.GDP.PCAP.PP.KD), FMI PEM",
lb:"English",
v:["Top 10","Rangs 11\u201320","Les 20 premiers"],
lh:"Cliquez sur un pays pour le mettre en surbrillance \u00b7 cliquez \u00e0 nouveau pour r\u00e9initialiser",
xl:"Ann\u00e9e",yl:"PIB par hab. (PPA, $ intl const. 2021, milliers)",
dl:"D\u00e9finition",
dt:"PIB par habitant en parit\u00e9 de pouvoir d\u2019achat (PPA), exprim\u00e9 en dollars internationaux constants de 2021. Les facteurs de conversion PPA tiennent compte des diff\u00e9rences de niveaux de prix entre les pays ; les prix constants corrigent l\u2019inflation au fil du temps, permettant des comparaisons significatives entre pays et entre ann\u00e9es.",
sl:"Sources",
st:"Banque mondiale, Indicateurs du d\u00e9veloppement dans le monde (indicateur NY.GDP.PCAP.PP.KD) ; Programme de comparaison internationale (PCI) ; FMI, Perspectives de l\u2019\u00e9conomie mondiale. Donn\u00e9es compil\u00e9es d\u00e9but 2025. Remarque : Certaines juridictions \u00e0 PIB par habitant \u00e9lev\u00e9 (par ex. l\u2019Irlande, le Luxembourg, Singapour) pr\u00e9sentent des chiffres influenc\u00e9s par la comptabilit\u00e9 des multinationales et les effets de paradis fiscal.",
at:"Observations cl\u00e9s",
a:[
["Le Luxembourg reste en t\u00eate","Le Luxembourg a syst\u00e9matiquement occup\u00e9 la 1re ou 2e position au cours des vingt derni\u00e8res ann\u00e9es. Son PIB par habitant surdimensionn\u00e9 refl\u00e8te une petite population combin\u00e9e \u00e0 un secteur financier massif \u2014 le pays abrite le si\u00e8ge europ\u00e9en de nombreuses banques et fonds d\u2019investissement mondiaux."],
["Le long d\u00e9clin du Qatar depuis son sommet","Le Qatar \u00e9tait le leader mondial incontest\u00e9 en 2010\u20132013, avec un pic au-dessus de 134 000 $, gr\u00e2ce aux \u00e9normes revenus du gaz naturel r\u00e9partis entre une population citoyenne relativement r\u00e9duite. Depuis, la croissance d\u00e9mographique et les efforts de diversification ont progressivement r\u00e9duit la production par habitant en termes de PPA."],
["Le saut de l\u2019Irlande et la \u00ab leprechaun economics \u00bb","Le bond spectaculaire de l\u2019Irlande vers 2015 est l\u2019un des traits les plus frappants du graphique. Il refl\u00e8te la reclassification d\u2019actifs de propri\u00e9t\u00e9 intellectuelle par les multinationales (notamment dans la tech et la pharmacie) via des filiales irlandaises \u2014 gonflant le PIB sans changement proportionnel du niveau de vie des r\u00e9sidents. L\u2019Irlande elle-m\u00eame a reconnu cette distorsion et a cr\u00e9\u00e9 une mesure alternative appel\u00e9e RNB* (revenu national brut modifi\u00e9)."],
["L\u2019effondrement et la reprise de Macao pendant le COVID","L\u2019\u00e9conomie de Macao, presque enti\u00e8rement d\u00e9pendante des casinos et du tourisme, a connu la variation la plus dramatique de toutes les juridictions du graphique. Son PIB par habitant est pass\u00e9 de plus de 100 000 $ \u00e0 environ 30 000 $ pendant les confinements de la pand\u00e9mie, et se redresse depuis la r\u00e9ouverture des fronti\u00e8res chinoises."],
["L\u2019ascension r\u00e9guli\u00e8re de Ta\u00efwan","La trajectoire de Ta\u00efwan est peut-\u00eatre l\u2019histoire de croissance soutenue la plus impressionnante ici \u2014 pr\u00e8s d\u2019un doublement de ~36 000 $ en 2004 \u00e0 ~70 000 $ en 2024, port\u00e9 par sa position dominante dans la fabrication de semi-conducteurs (TSMC) et une \u00e9conomie d\u2019exportation technologique diversifi\u00e9e."],
["Les pays nordiques et l\u2019Europe occidentale : stables mais tr\u00e8s regroup\u00e9s","Le Danemark, les Pays-Bas, la Su\u00e8de, l\u2019Islande, l\u2019Allemagne, l\u2019Autriche, la Belgique et les autres nations d\u2019Europe occidentale se regroupent entre 58 000 $ et 70 000 $ \u2014 croissant r\u00e9guli\u00e8rement mais \u00e0 des rythmes similaires, refl\u00e9tant des \u00e9conomies matures avec des filets de s\u00e9curit\u00e9 sociale solides et des bases industrielles diversifi\u00e9es."],
["Les \u00c9tats-Unis : un \u00e9cart qui se creuse","Parmi les grandes \u00e9conomies, les \u00c9tats-Unis se distinguent par une croissance acc\u00e9l\u00e9r\u00e9e apr\u00e8s 2020, atteignant ~76 000 $ \u2014 consid\u00e9rablement au-dessus de leurs homologues europ\u00e9ens. Cette divergence a \u00e9t\u00e9 port\u00e9e par le secteur technologique, une croissance plus forte de la productivit\u00e9 du travail et des choix de politique budg\u00e9taire diff\u00e9rents."]
],
an:"Ces observations sont des points de d\u00e9part pour la discussion. Le PIB par habitant (PPA) est un indicateur utile mais imparfait du niveau de vie mat\u00e9riel \u2014 il ne capture ni la r\u00e9partition des revenus, ni la qualit\u00e9 des services publics, ni la durabilit\u00e9 environnementale, ni le bien-\u00eatre subjectif.",
bw:"Donn\u00e9es de la Banque mondiale et du FMI"
}
};

/* ═══ State ═══ */
var lang="en",view="top10",hiC=null;
var AK=Object.keys(D);AK.sort(function(a,b){return D[b][20]-D[a][20]});
var T10=AK.slice(0,10),R11=AK.slice(10,20),A20=AK.slice(0,20);

function gc(){return view==="top10"?T10:view==="rank1120"?R11:A20}
function gp(){return view==="top10"?PAL.slice(0,10):view==="rank1120"?PAL.slice(10,20):PAL}
function dn(c){return lang==="fr"?(FN[c]||c):c}

/* ═══ Canvas Chart ═══ */
var cv=document.getElementById("cv"),ctx=cv.getContext("2d"),tip=document.getElementById("tip");
var dpr=window.devicePixelRatio||1;
var PAD={t:20,r:14,b:48,l:58};
var cw,ch,pw,ph;

function resize(){
  var box=cv.parentElement;
  var mob=window.innerWidth<640;
  var h=mob?360:500;
  cw=box.clientWidth; ch=h;
  cv.width=cw*dpr; cv.height=ch*dpr;
  cv.style.width=cw+"px"; cv.style.height=ch+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
  pw=cw-PAD.l-PAD.r; ph=ch-PAD.t-PAD.b;
}

function drawChart(){
  resize();
  var cs=gc(),cols=gp();
  /* find y bounds */
  var yMin=1e9,yMax=0;
  cs.forEach(function(c){D[c].forEach(function(v){if(v<yMin)yMin=v;if(v>yMax)yMax=v})});
  yMin=Math.floor(yMin/10)*10; yMax=Math.ceil(yMax/10)*10+5;
  var t=T[lang];

  ctx.clearRect(0,0,cw,ch);

  /* grid + y ticks */
  var yStep=yMax>100?20:10;
  ctx.textAlign="right"; ctx.textBaseline="middle";
  for(var v=yMin;v<=yMax;v+=yStep){
    var py=PAD.t+ph-(v-yMin)/(yMax-yMin)*ph;
    ctx.strokeStyle="rgba(148,163,184,0.08)"; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(PAD.l,py); ctx.lineTo(PAD.l+pw,py); ctx.stroke();
    ctx.fillStyle="#94a3b8"; ctx.font="11px -apple-system,sans-serif";
    ctx.fillText("$"+v+"k",PAD.l-6,py);
  }

  /* x ticks */
  var mob=window.innerWidth<640;
  ctx.textAlign="center"; ctx.textBaseline="top";
  YR.forEach(function(yr,i){
    if(mob&&i%4!==0)return;
    var px=PAD.l+i/(YR.length-1)*pw;
    ctx.fillStyle="#94a3b8"; ctx.font="11px -apple-system,sans-serif";
    ctx.fillText(yr,px,ch-PAD.b+8);
    ctx.strokeStyle="rgba(148,163,184,0.05)"; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(px,PAD.t); ctx.lineTo(px,PAD.t+ph); ctx.stroke();
  });

  /* axis labels */
  ctx.fillStyle="#64748b"; ctx.font="12px -apple-system,sans-serif";
  ctx.textAlign="center"; ctx.fillText(t.xl,PAD.l+pw/2,ch-6);
  ctx.save(); ctx.translate(14,PAD.t+ph/2); ctx.rotate(-Math.PI/2);
  ctx.font="11px -apple-system,sans-serif"; ctx.fillText(t.yl,0,0); ctx.restore();

  /* lines */
  cs.forEach(function(c,ci){
    var isHi=hiC===c, isDim=hiC&&!isHi;
    ctx.strokeStyle=isDim?cols[ci%cols.length]+"30":cols[ci%cols.length];
    ctx.lineWidth=isHi?3.5:isDim?1:2;
    ctx.lineJoin="round"; ctx.lineCap="round";
    ctx.beginPath();
    D[c].forEach(function(v,i){
      var px=PAD.l+i/(YR.length-1)*pw;
      var py=PAD.t+ph-(v-yMin)/(yMax-yMin)*ph;
      i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);
    });
    ctx.stroke();
  });

  /* store for hit-test */
  cv._meta={cs:cs,cols:cols,yMin:yMin,yMax:yMax};
}

/* ═══ Tooltip ═══ */
function showTip(e){
  var m=cv._meta; if(!m)return;
  var rect=cv.getBoundingClientRect();
  var mx=e.clientX-rect.left, my=e.clientY-rect.top;
  /* find nearest year index */
  var xi=Math.round((mx-PAD.l)/pw*(YR.length-1));
  if(xi<0||xi>=YR.length){tip.style.display="none";return;}

  var entries=[];
  m.cs.forEach(function(c,ci){
    entries.push({c:c,v:D[c][xi],col:m.cols[ci%m.cols.length]});
  });
  entries.sort(function(a,b){return b.v-a.v});

  var h='<div class="th">'+YR[xi]+'</div>';
  entries.forEach(function(e){
    h+='<div class="tr"><div class="td" style="background:'+e.col+'"></div><span class="tn">'+dn(e.c)+'</span><span class="tv">$'+e.v.toFixed(1)+'k</span></div>';
  });
  tip.innerHTML=h; tip.style.display="block";

  /* position */
  var tx=mx+16, ty=my-20;
  if(tx+tip.offsetWidth>cw) tx=mx-tip.offsetWidth-12;
  if(ty<0) ty=4;
  if(ty+tip.offsetHeight>ch) ty=ch-tip.offsetHeight-4;
  tip.style.left=tx+"px"; tip.style.top=ty+"px";

  /* draw crosshair */
  drawChart();
  var px=PAD.l+xi/(YR.length-1)*pw;
  ctx.strokeStyle="rgba(148,163,184,0.2)"; ctx.lineWidth=1;
  ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(px,PAD.t); ctx.lineTo(px,PAD.t+ph); ctx.stroke();
  ctx.setLineDash([]);

  /* dots */
  m.cs.forEach(function(c,ci){
    var v=D[c][xi];
    var py=PAD.t+ph-(v-m.yMin)/(m.yMax-m.yMin)*ph;
    var isDim=hiC&&hiC!==c;
    ctx.fillStyle=isDim?m.cols[ci%m.cols.length]+"30":m.cols[ci%m.cols.length];
    ctx.beginPath(); ctx.arc(px,py,3.5,0,Math.PI*2); ctx.fill();
  });
}

cv.addEventListener("mousemove",showTip);
cv.addEventListener("touchmove",function(e){
  e.preventDefault();
  var touch=e.touches[0];
  showTip({clientX:touch.clientX,clientY:touch.clientY});
},{passive:false});
cv.addEventListener("mouseleave",function(){tip.style.display="none";drawChart()});
cv.addEventListener("touchend",function(){tip.style.display="none";drawChart()});

/* ═══ Legend ═══ */
function buildLeg(){
  var cs=gc(),cols=gp(),el=document.getElementById("lgd");el.innerHTML="";
  cs.forEach(function(c,i){
    var d=document.createElement("div");
    d.className="li"+(hiC===c?" on":(hiC&&hiC!==c?" dim":""));
    d.innerHTML='<div class="ls" style="background:'+cols[i%cols.length]+'"></div><span class="ln">'+dn(c)+'</span><span class="lv">$'+Math.round(D[c][20])+'k</span>';
    d.addEventListener("click",function(){hiC=(hiC===c)?null:c;drawChart();buildLeg()});
    el.appendChild(d);
  });
}

/* ═══ View buttons ═══ */
function buildVB(){
  var t=T[lang],el=document.getElementById("vb");el.innerHTML="";
  ["top10","rank1120","all20"].forEach(function(v,i){
    var b=document.createElement("button");
    b.className="b"+(view===v?" on":"");
    b.textContent=t.v[i];
    b.addEventListener("click",function(){view=v;hiC=null;render()});
    el.appendChild(b);
  });
}

/* ═══ Analysis ═══ */
function buildA(){
  var t=T[lang],el=document.getElementById("acd");
  var h="<h2>"+t.at+"</h2>";
  t.a.forEach(function(x,i){h+='<div class="ai"><h3>'+(i+1)+". "+x[0]+"</h3><p>"+x[1]+"</p></div>"});
  h+='<p class="an">'+t.an+"</p>";
  el.innerHTML=h;
}

/* ═══ Full render ═══ */
function render(){
  var t=T[lang];
  document.getElementById("pt").innerHTML=t.t+"<span>"+t.ts+"</span>";
  document.getElementById("ps").textContent=t.ds;
  document.getElementById("lb").textContent=t.lb;
  document.getElementById("lht").textContent=t.lh;
  document.getElementById("df").innerHTML="<strong>"+t.dl+" :</strong> "+t.dt;
  document.getElementById("sr").innerHTML="<strong>"+t.sl+" :</strong> "+t.st;
  document.getElementById("ftr").innerHTML="<p>"+t.bw+"</p><p style='margin-top:4px'>\u00a9 "+new Date().getFullYear()+" Corey Prator</p>";
  document.documentElement.lang=lang;
  buildVB(); drawChart(); buildLeg(); buildA();
}

window.TL=function(){lang=lang==="en"?"fr":"en";render()};
window.addEventListener("load",render);
var rt;window.addEventListener("resize",function(){clearTimeout(rt);rt=setTimeout(render,120)});

})();
</script>
</body>
</html>
